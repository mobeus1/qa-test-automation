name: Run TestComplete Tests

on:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name matching configs/apps/{app-name}/testcomplete.json'
        required: true
        type: string
      environment:
        description: 'Target environment (staging or production)'
        required: true
        type: string
      test-suite:
        description: 'Test suite to execute (e.g., SmokeTests, RegressionTests, FullRegression)'
        required: false
        type: string
        default: 'SmokeTests'
    secrets:
      TEST_EXECUTE_ACCESS_KEY:
        required: true
      NOTIFICATION_WEBHOOK:
        required: false

jobs:
  run-tests:
    runs-on: [self-hosted, windows, testcomplete]
    timeout-minutes: 60

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load App Configuration
        id: config
        shell: pwsh
        run: |
          $configPath = "configs/apps/${{ inputs.app-name }}/testcomplete.json"
          if (-not (Test-Path $configPath)) {
            Write-Error "Config not found: $configPath"
            exit 1
          }

          $config = Get-Content $configPath | ConvertFrom-Json
          echo "project-suite=$($config.project_suite)" >> $env:GITHUB_OUTPUT
          echo "timeout=$($config.timeout_minutes)" >> $env:GITHUB_OUTPUT

          # Get environment-specific settings
          $envConfig = $config.environments.${{ inputs.environment }}
          if ($null -eq $envConfig) {
            Write-Error "Environment '${{ inputs.environment }}' not found in config"
            exit 1
          }
          echo "base-url=$($envConfig.base_url)" >> $env:GITHUB_OUTPUT
          echo "credentials-secret=$($envConfig.credentials_secret)" >> $env:GITHUB_OUTPUT

          # Get test items for the suite
          $testItems = $config.test_items.'${{ inputs.test-suite }}'
          if ($null -eq $testItems) {
            Write-Error "Test suite '${{ inputs.test-suite }}' not found in config"
            exit 1
          }
          $itemList = $testItems -join ','
          echo "test-items=$itemList" >> $env:GITHUB_OUTPUT

      - name: Run TestComplete Suite
        id: execute
        shell: cmd
        env:
          TC_ACCESS_KEY: ${{ secrets.TEST_EXECUTE_ACCESS_KEY }}
          TEST_ENV: ${{ inputs.environment }}
          BASE_URL: ${{ steps.config.outputs.base-url }}
        run: |
          scripts\\run-tests.bat ^
            "${{ steps.config.outputs.project-suite }}" ^
            "${{ inputs.test-suite }}" ^
            "${{ steps.config.outputs.test-items }}"

      - name: Parse Test Results
        if: always()
        id: results
        shell: pwsh
        run: |
          python scripts/parse-results.py ^
            --results-dir "TestResults" ^
            --output-format github ^
            --suite-name "${{ inputs.test-suite }}"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testcomplete-results-${{ inputs.app-name }}-${{ inputs.environment }}
          path: TestResults/
          retention-days: 30

      - name: Notify on Failure
        if: failure() && secrets.NOTIFICATION_WEBHOOK != ''
        shell: pwsh
        run: |
          python scripts/notify.py ^
            --webhook "${{ secrets.NOTIFICATION_WEBHOOK }}" ^
            --app "${{ inputs.app-name }}" ^
            --environment "${{ inputs.environment }}" ^
            --suite "${{ inputs.test-suite }}" ^
            --status "failed" ^
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
