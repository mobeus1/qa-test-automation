name: Run TestComplete Tests

on:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name matching CareFirst-qa-data/apps/{app-name}/testcomplete.json'
        required: true
        type: string
      environment:
        description: 'Target environment (staging or production)'
        required: true
        type: string
      test-suite:
        description: 'Test suite to execute (e.g., SmokeTests, RegressionTests, FullRegression)'
        required: false
        type: string
        default: 'SmokeTests'
    secrets:
      TEST_EXECUTE_ACCESS_KEY:
        required: true
      NOTIFICATION_WEBHOOK:
        required: false

jobs:
  run-tests:
    runs-on: [self-hosted, windows, testcomplete]
    timeout-minutes: 60
    env:
      DATA_REPO: ${{ github.repository_owner }}/CareFirst-qa-data

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Checkout Test Data Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DATA_REPO }}
          path: qa-data
          token: ${{ secrets.DATA_REPO_PAT || github.token }}

      - name: Load App Configuration
        id: config
        shell: pwsh
        run: |
          $configPath = "qa-data/apps/${{ inputs.app-name }}/testcomplete.json"
          if (-not (Test-Path $configPath)) {
            Write-Error "Config not found: $configPath"
            exit 1
          }

          $config = Get-Content $configPath | ConvertFrom-Json
          $suitePath = Join-Path "qa-data/apps/${{ inputs.app-name }}/testcomplete" $config.project_suite
          echo "project-suite=$suitePath" >> $env:GITHUB_OUTPUT
          echo "timeout=$($config.timeout_minutes)" >> $env:GITHUB_OUTPUT

          # Get environment-specific settings
          $envConfig = $config.environments.${{ inputs.environment }}
          if ($null -eq $envConfig) {
            Write-Error "Environment '${{ inputs.environment }}' not found in config"
            exit 1
          }
          echo "base-url=$($envConfig.base_url)" >> $env:GITHUB_OUTPUT
          echo "credentials-secret=$($envConfig.credentials_secret)" >> $env:GITHUB_OUTPUT

          # Get test items for the suite
          $testItems = $config.test_items.'${{ inputs.test-suite }}'
          if ($null -eq $testItems) {
            Write-Error "Test suite '${{ inputs.test-suite }}' not found in config"
            exit 1
          }
          $itemList = $testItems -join ','
          echo "test-items=$itemList" >> $env:GITHUB_OUTPUT

      - name: Validate TestComplete Inputs
        shell: pwsh
        run: |
          $suitePath = "${{ steps.config.outputs.project-suite }}"
          if (-not (Test-Path $suitePath)) {
            Write-Error "Project suite not found: $suitePath"
            exit 1
          }

          $items = "${{ steps.config.outputs.test-items }}"
          if ([string]::IsNullOrWhiteSpace($items)) {
            Write-Error "No test items configured for suite '${{ inputs.test-suite }}'"
            exit 1
          }

      - name: Run TestComplete Suite
        id: execute
        shell: cmd
        run: |
          scripts\\run-tests.bat ^
            "${{ steps.config.outputs.project-suite }}" ^
            "${{ steps.config.outputs.test-items }}" ^
            "${{ secrets.TEST_EXECUTE_ACCESS_KEY }}" ^
            "${{ steps.config.outputs.base-url }}"

      - name: Parse Test Results
        if: always()
        id: results
        shell: pwsh
        run: |
          python scripts/parse-results.py ^
            --app "${{ inputs.app-name }}" ^
            --env "${{ inputs.environment }}" ^
            --suite-name "${{ inputs.test-suite }}" ^
            --results-dir "test-results"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testcomplete-results-${{ inputs.app-name }}-${{ inputs.environment }}
          path: test-results/
          retention-days: 30

      - name: Notify on Failure
        if: failure() && secrets.NOTIFICATION_WEBHOOK != ''
        shell: pwsh
        run: |
          python scripts/notify.py ^
            --webhook "${{ secrets.NOTIFICATION_WEBHOOK }}" ^
            --app "${{ inputs.app-name }}" ^
            --environment "${{ inputs.environment }}" ^
            --suite "${{ inputs.test-suite }}" ^
            --status "failed" ^
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
